<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quantitative Project</title>
  <style>
    :root{
      --hitam:#000; --putih:#fff;
      --biru-tipis:#5fa8d3; --biru-cerah:#4cc9f0;
      --merah:#e63946;
      --border:2px; --radius:14px;
      --shadow:0 10px 30px rgba(95,168,211,.25);
      --field-h:46px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:#000;color:#fff;display:flex;min-height:100vh}
    .app{display:flex;flex-direction:column;align-items:center;gap:28px;width:100%;padding:28px 18px}

    /* Frames/headers */
    .frame{width:100%;max-width:1100px;border:var(--border) solid rgba(95,168,211,.75);border-radius:var(--radius);padding:28px;background:rgba(255,255,255,0.02);box-shadow:var(--shadow)}
    .title{font-weight:800;letter-spacing:.5px;text-align:center;line-height:1.05}
    .subtitle{opacity:.9;text-align:center;margin-top:14px}
    .section{width:100%;max-width:900px;display:flex;flex-direction:column;gap:18px}
    .label{font-size:18px;letter-spacing:.6px;opacity:.9;text-align:center;margin-top:6px}

    /* Home */
    .home-header{padding:40px 32px}
    .home-title{font-size:clamp(36px,7vw,72px)}
    .home-subtitle{font-size:clamp(18px,3vw,28px);font-weight:500}
    .home-actions{width:100%;max-width:1100px;display:grid;gap:34px;grid-template-columns:repeat(2,minmax(260px,1fr))}
    @media (max-width:740px){.home-actions{grid-template-columns:1fr}}
    .big-btn{
      display:flex;align-items:center;justify-content:center;text-decoration:none;color:#fff;
      border:var(--border) solid rgba(95,168,211,.75);border-radius:var(--radius);
      padding:38px 18px;font-weight:700;font-size:clamp(22px,4.4vw,42px);
      background:rgba(255,255,255,0.02);transition:.2s;text-align:center;
    }
    .big-btn:hover,.big-btn:focus-visible{transform:translateY(-2px);background:rgba(76,201,240,0.08);box-shadow:0 12px 30px rgba(76,201,240,.25);border-color:var(--biru-cerah);outline:none}

    /* Toolbar / buttons */
    .toolbar{width:100%;max-width:1100px;display:flex;flex-wrap:wrap;align-items:center;gap:12px}
    .btn{
      border:var(--border) solid rgba(95,168,211,.75);border-radius:10px;background:transparent;color:#fff;
      padding:10px 14px;cursor:pointer;font-weight:700;transition:.2s
    }
    .btn:hover{border-color:var(--biru-cerah)}
    .btn-primary{background:var(--biru-tipis);border:none;color:#001014}
    .btn-primary:hover{filter:brightness(1.08)}

    /* Form */
    .form{display:grid;gap:16px;margin-top:6px}
    .row{display:grid;gap:12px}
    .form input{
      background:transparent;color:#fff;border:none;border-bottom:2px dotted #fff;
      padding:0 10px;height:var(--field-h);font-size:18px;text-align:center
    }
    .form input:focus{outline:none;border-bottom:2px solid var(--biru-cerah)}
    /* Hiding elements */
    .hide-on-url{display: block;}
    .hide-on-url.hidden{display: none;}

    /* Cities and Interviewers */
    #cities, #interviewers{display:flex;flex-direction:column;gap:10px}

    /* Style for City input list */
    .city-wrapper{
        border: 1px dashed rgba(76, 201, 240, .2); 
        padding: 12px; 
        border-radius: 10px; 
        margin-bottom: 16px;
    }
    .city-header{display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;}
    .city-header input{flex: 1; text-align: left !important; height: 40px !important; border-bottom: 2px solid rgba(255, 255, 255, 0.4) !important;}
    
    .city-row{display: flex; gap: 8px; align-items: center;}
    .city-row input{flex: 1; text-align: left !important;}
    .city-row .remove-city{
        width: 34px !important; 
        height: 34px !important; 
        border-radius: 8px !important; 
        font-size: 20px; 
        line-height: 0;
        margin-top: 0 !important;
        cursor: pointer;
    }
    .add-city-mini {
        justify-self: center;
        border: 1px dashed rgba(95, 168, 211, .6);
        border-radius: 10px;
        background: rgba(255, 255, 255, .03);
        color: #cde8f7;
        padding: 8px 12px;
        cursor: pointer;
    }
    .add-city-mini:hover {
        border-color: var(--biru-cerah);
        color: #fff;
    }

    /* Interviewers */
    .iv-section{ /* Container for interviewer and all its links */
        border: 1px dashed rgba(95,168,211,.6); /* Dotted border for sub-section */
        padding: 12px; 
        border-radius: 10px; 
        margin-top: 10px;
    }
    .links-container > div { /* Wrapper for one link input and its remove button */
        display: flex; 
        gap: 8px; 
        align-items: center;
    }
    .links-container > div:not(:last-child) {
        margin-bottom: 8px;
    }
    .iv-name { /* Ensure name field stands out */
        flex: 1; 
        height: 40px !important; 
        border-bottom: 2px solid rgba(255, 255, 255, 0.4) !important;
        text-align: left !important;
    }
    .iv-link {
        flex: 1;
        text-align: left !important;
    }

    .remove {
        width: 44px;
        height: var(--field-h);
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(95, 168, 211, .75);
        border-radius: 10px;
        background: transparent;
        color: #fff;
        cursor: pointer;
        transition: .2s;
    }
    .remove:hover{border-color:var(--biru-cerah)}

    .remove-link { /* style for the small remove link button */
        width: 34px !important; 
        height: 34px !important; 
        border-radius: 8px !important; 
        font-size: 20px; 
        line-height: 0;
        margin-top: 0 !important;
    }

    .add-mini{justify-self:center;border:1px dashed rgba(95,168,211,.6);border-radius:10px;background:rgba(255,255,255,.03);color:#cde8f7;padding:8px 12px;cursor:pointer}
    .add-mini:hover{border-color:var(--biru-cerah);color:#fff}
    @media (max-width:760px){.iv-row{grid-template-columns:1fr}.iv-row .remove{justify-self:end}}

    /* Cards / link list */
    .links{display:grid;gap:18px;margin-top:10px;grid-template-columns:1fr 1fr}
    @media (max-width:900px){.links{grid-template-columns:1fr}}
    .card, .card-link, .card-clickable{ /* Added .card-clickable */
      position:relative;display:block;width:100%;text-align:left;background:rgba(255,255,255,.03);
      border:1px solid rgba(95,168,211,.6);border-radius:12px;padding:16px 18px;color:#fff;text-decoration:none;transition:.15s ease
    }
    .card:hover,.card-link:hover, .card-clickable:hover{ /* Added .card-clickable:hover */
      transform:translateY(-1px);box-shadow:0 8px 18px rgba(76,201,240,.18);border-color:var(--biru-cerah);
      cursor: pointer; /* Ensure the cursor shows it's clickable */
    }
    .card-title{font-weight:800;font-size:18px;margin-bottom:6px}
    .card-meta{font-size:14px;opacity:.9;margin-bottom:6px}
    .tag{display:inline-block;background:rgba(95,168,211,.15);border:1px solid rgba(95,168,211,.5);color:#def5ff;border-radius:8px;padding:2px 8px;margin:2px 4px 0 0;font-size:12px}
    .tag a{color:#def5ff}
    
    /* NEW: Detail page styling for buttons */
    .detail-container{display: flex; flex-direction: column; gap: 14px;}
    .detail-interviewer{
        background: rgba(95,168,211,.1);
        border: 1px solid rgba(95,168,211,.7);
        border-radius: 10px;
        padding: 14px;
    }
    .detail-interviewer strong{font-size: 16px; display: block; margin-bottom: 8px;}
    .link-btn-container{display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;}
    .link-btn{
        padding: 8px 12px;
        background: var(--biru-tipis);
        color: #001014;
        border-radius: 8px;
        font-weight: 700;
        text-decoration: none;
        transition: background-color .15s;
    }
    .link-btn:hover{background: var(--biru-cerah);}

    /* Selection mode checkbox */
    .select-box{
      position:absolute;left:10px;top:10px;transform:scale(1.15);
      accent-color:#79c9ff; /* modern browsers */
    }
    .card.pad-left{padding-left:48px} .card-link.pad-left{padding-left:48px} .card-clickable.pad-left{padding-left:48px}

    /* Floating delete selected */
    .delete-fab{
      position:fixed;right:20px;bottom:20px;z-index:10;background:var(--merah);color:#fff;border:none;border-radius:12px;
      padding:12px 16px;font-weight:800;cursor:pointer;box-shadow:0 10px 24px rgba(0,0,0,.35);display:none
    }
    .delete-fab.show{display:block}
</style>
</head>
<body>
  <main id="app" class="app"></main>

  <script>
    /* ============== Router ============== */
    // Added 'detail' route
    const routes = { home: renderHome, input: routeInput, list: renderList, detail: renderDetail };
    function navigate(hash){ 
        const routeHash = hash || location.hash || '#/';
        // Regex to match the detail route format: #/detail/project_id
        const routeMatch = routeHash.match(/^#\/(detail)\/([a-z0-9_]+)$/);
        
        if (routeMatch) {
            // Found a detail route
            routes[routeMatch[1]](routeMatch[2]);
        } else {
            // Standard route
            const route = routeHash.replace('#/','') || 'home'; 
            (routes[route]||routes.home)(); 
        }
    }
    window.addEventListener('hashchange',()=>navigate()); 
    document.addEventListener('DOMContentLoaded',()=>navigate());

    /* ============== Auth ============== */
    const AUTH_KEY='acorn_auth', PASSWORD='acornquan';
    const isAuthed=()=>sessionStorage.getItem(AUTH_KEY)==='1';
    const setAuthed=()=>sessionStorage.setItem(AUTH_KEY,'1');
    const clearAuth=()=>sessionStorage.removeItem(AUTH_KEY);

    /* ============== Storage ============== */
    // UPDATED LS_KEY to V7 to avoid conflict with detail routing and complex data structure
    const LS_KEY='linksV7'; 
    const readAll=()=>{ try{return JSON.parse(localStorage.getItem(LS_KEY))||[]}catch{return[]} };
    const writeAll=arr=>localStorage.setItem(LS_KEY, JSON.stringify(arr));
    const upsert=p=>{ const arr=readAll(); arr.push(p); writeAll(arr); };
    const findById=(id)=>readAll().find(item => item.id === id);
    const removeByIds=(ids)=>{ const set=new Set(ids); writeAll(readAll().filter(x=>!set.has(x.id))); };
    const migrateIds=()=>{ const arr=readAll(); let changed=false; arr.forEach(it=>{ if(!it.id){ it.id=genId(); changed=true; } }); if(changed) writeAll(arr); };

    const genId=()=> 'p_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,7);

    /* ============== Home ============== */
    function renderHome(){
      const app=document.getElementById('app');
      app.innerHTML=`
        <section class="frame home-header" aria-labelledby="home-title">
          <h1 id="home-title" class="title home-title">Quantitative Project</h1>
          <p class="subtitle home-subtitle">Acorn Consultant</p>
        </section>
        <section class="home-actions">
          <a class="big-btn" href="#/input">Input Projects</a>
          <a class="big-btn" href="#/list">List Projects</a>
        </section>
      `;
    }

    /* ============== Input (gate) ============== */
    function routeInput(){ isAuthed()? renderInputPage() : renderGate(); }

    function renderGate(){
      const app=document.getElementById('app');
      app.innerHTML=`
        <div class="toolbar">
          <button class="btn" onclick="location.hash='#/';">← Back</button>
        </div>
        <section class="frame">
          <h2 class="title" style="font-size:28px;">Password Required</h2>
          <p class="subtitle">Masukkan password untuk mengakses <b>Input Projects</b>.</p>
          <div style="max-width:520px;margin:16px auto 0;display:flex;gap:12px">
            <input id="pwd" type="password" placeholder="Enter password" style="flex:1;background:transparent;color:#fff;border:none;border-bottom:2px dotted #fff;height:46px;text-align:center;font-size:18px"/>
            <button id="pwdBtn" class="btn btn-primary">Unlock</button>
          </div>
          <p class="subtitle" style="font-size:14px;opacity:.7">Password disimpan untuk sesi ini (tab ini saja).</p>
        </section>
      `;
      const pwd=document.getElementById('pwd');
      document.getElementById('pwdBtn').addEventListener('click',unlock);
      pwd.addEventListener('keydown',e=>{if(e.key==='Enter')unlock();}); pwd.focus();
      function unlock(){ if(pwd.value===PASSWORD){ setAuthed(); renderInputPage(); } else { alert('Incorrect password.'); pwd.value=''; pwd.focus(); } }
    }

    /* ============== Input Page ============== */
    let selectionMode=false;            // on/off
    const selectedIds=new Set();        // ids selected

    function renderInputPage(){
      migrateIds(); 

      const app=document.getElementById('app');
      app.innerHTML=`
        <div class="toolbar">
          <button class="btn" onclick="location.hash='#/';">← Back</button>
          <button class="btn" onclick="clearAuth();location.hash='#/';">Log out</button>
          <button id="toggleSel" class="btn" style="margin-left:auto">Selection Mode: OFF</button>
        </div>

        <section class="frame section">
          <h2 class="title" style="font-size:28px;">Input Projects</h2>
          <p class="label">PUT THE LINK BELOW</p>

          <div class="form">
            <div class="row"><input id="projectName" type="text" placeholder="Project Name (required)"/></div>
            
            <div class="row"><input id="projectURL" type="url" placeholder="URL (optional, https://...)"/></div>
            
            <div class="row hide-on-url">
                <div id="cities"></div>
                <button type="button" id="addCity" class="add-city-mini">+ Add City</button>
            </div>

            <button id="saveBtn" class="btn btn-primary">Save Link</button>
          </div>

          <div class="links" id="listInput"></div>
        </section>

        <button id="deleteSelected" class="delete-fab">Delete Selected (PIN)</button>
      `;

      const projectNameInput = document.getElementById('projectName');
      const projectURLInput = document.getElementById('projectURL');
      const saveBtn = document.getElementById('saveBtn');
      const citiesContainer = document.getElementById('cities');
      const addCityBtn = document.getElementById('addCity');


      // --- HELPER FUNCTIONS FOR LINKS AND INTERVIEWERS (NESTED) ---

      const addLinkInput = (container, link = '') => {
        const input = document.createElement('input');
        input.className = 'iv-link';
        input.type = 'url';
        input.placeholder = 'Link (Wajib) / More link (optional, https://...)';
        input.value = esc(link);

        const removeLinkBtn = document.createElement('button');
        removeLinkBtn.type = 'button';
        removeLinkBtn.className = 'remove remove-link'; 
        removeLinkBtn.title = 'Hapus Link';
        removeLinkBtn.textContent = '–';
        removeLinkBtn.style.cssText = 'width: 34px; height: 34px; border-radius: 8px; font-size: 20px; line-height: 0; margin-top: 0;';

        const wrapper = document.createElement('div');
        wrapper.style.cssText = 'display: flex; gap: 8px; align-items: center;';
        wrapper.appendChild(input);
        wrapper.appendChild(removeLinkBtn);

        removeLinkBtn.addEventListener('click', () => {
            if (container.querySelectorAll('.iv-link').length > 1) {
                wrapper.remove();
            } else {
                alert('Setiap interviewer wajib memiliki minimal satu link.');
            }
        });

        container.appendChild(wrapper);
        return input;
      };

      const addInterviewerRow = (container, name = '', links = ['']) => {
        const ivID = genId(); 

        const div=document.createElement('div');
        div.className='iv-section'; 
        div.style.cssText = 'border: 1px dashed rgba(95,168,211,.6); padding: 12px; border-radius: 10px; margin-top: 10px;';

        div.innerHTML=`
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 12px;">
            <input class="iv-name" type="text" placeholder="Interviewer Name (Wajib)" value="${esc(name)}" style="flex:1; height: 40px; border-bottom: 2px solid rgba(255, 255, 255, 0.4);"/>
            <button type="button" class="remove" title="Hapus Interviewer" style="width: 34px; height: 34px; margin-left: 12px; border-radius: 8px;">✕</button>
          </div>
          <div id="links-container-${ivID}" class="links-container"></div>
          <button type="button" class="add-mini add-link-mini" style="margin-top: 8px; font-size: 14px; padding: 6px 10px;">+ More Link</button>
        `;

        const linksContainer = div.querySelector(`#links-container-${ivID}`);

        (links.length > 0 ? links : ['']).forEach(link => addLinkInput(linksContainer, link));

        div.querySelector('.add-link-mini').addEventListener('click', () => addLinkInput(linksContainer));

        div.querySelector('.remove').addEventListener('click',()=>div.remove());

        container.appendChild(div);
      };

      // --- CITY INPUT LOGIC (MAIN) ---

      // Function to add a single city input field with nested interviewers
      const addCityInput = (container, city = '', initialInterviewers = [{name: '', links: ['']}]) => {
        const cityWrapper = document.createElement('div');
        cityWrapper.className = 'city-wrapper';
        
        cityWrapper.innerHTML = `
            <div class="city-header">
                <input class="city-name" type="text" placeholder="City Name (Wajib)" value="${esc(city)}" />
                <button type="button" class="remove remove-city" title="Remove city" style="width: 34px; height: 34px; margin-left: 12px; border-radius: 8px;">✕</button>
            </div>
            <p class="subtitle" style="text-align:left; margin-top: -10px; font-size: 14px; opacity: 0.8;">Interviewer untuk kota ini:</p>
            <div class="city-interviewers"></div>
            <button type="button" class="add-mini add-interviewer-city" style="font-size: 14px; padding: 6px 10px; margin-top: 8px; width: 100%;">+ Add Interviewer</button>
        `;

        const cityNameInput = cityWrapper.querySelector('.city-name');
        const interviewersContainer = cityWrapper.querySelector('.city-interviewers');
        const removeCityBtn = cityWrapper.querySelector('.remove-city');
        const addInterviewerBtn = cityWrapper.querySelector('.add-interviewer-city');


        // Initial Interviewers for this city
        // If initialInterviewers has valid data, use it. Otherwise, add one empty row.
        const hasValidInitialIv = initialInterviewers && initialInterviewers.length > 0 && (initialInterviewers[0].name || initialInterviewers[0].links[0]);
        const ivData = hasValidInitialIv ? initialInterviewers : [{name: '', links: ['']}];
        ivData.forEach(iv => addInterviewerRow(interviewersContainer, iv.name, iv.links));

        // Event Listeners
        cityNameInput.addEventListener('input', updateInputMode);

        addInterviewerBtn.addEventListener('click', () => {
            addInterviewerRow(interviewersContainer);
        });
        
        removeCityBtn.addEventListener('click', () => {
            // Logic: remove if there's more than one city input, or if it's the only one and it's currently empty
            const cityWrappers = container.querySelectorAll('.city-wrapper');
            if (cityWrappers.length > 1 || !cityNameInput.value.trim()) {
                cityWrapper.remove();
                updateInputMode();
            } else {
                alert('Tidak bisa menghapus satu-satunya kolom kota yang terisi.');
            }
        });

        container.appendChild(cityWrapper);
        return cityWrapper;
      };

      // Add City Button Handler
      addCityBtn.addEventListener('click', () => {
          addCityInput(citiesContainer);
      });
      addCityInput(citiesContainer); // Initial city input field

      // --- INPUT MODE LOGIC (URL vs CITY/DEFAULT) ---

      function updateInputMode() {
          const urlValue = (projectURLInput.value || '').trim();
          const cityInputs = citiesContainer.querySelectorAll('.city-name');
          // Cek apakah ada kota yang terisi (trim() !== '')
          const hasCityValue = Array.from(cityInputs).some(input => (input.value || '').trim() !== '');
          const hideElements = document.querySelectorAll('.hide-on-url');
          
          if (urlValue) {
              // MODE URL: URL terisi. Sembunyikan Cities.
              hideElements.forEach(el => el.classList.add('hidden'));
              saveBtn.textContent = 'Save Project (URL Only)';
              
              // Clear City inputs and Interviewers when hidden to avoid accidental save
              citiesContainer.innerHTML = ''; addCityInput(citiesContainer);
              
          } else {
              // MODE CITY/DEFAULT: URL kosong. Tampilkan Cities.
              hideElements.forEach(el => el.classList.remove('hidden'));
              
              if (hasCityValue) {
                  saveBtn.textContent = 'Save Project (City)';
              } else {
                  saveBtn.textContent = 'Save Link (No City/Interviewer)';
              }
          }
      }

      // Add event listeners to control visibility
      projectURLInput.addEventListener('input', updateInputMode);

      // Run once on load to set initial state
      updateInputMode();


      // --- GENERAL ACTIONS ---

      document.getElementById('saveBtn').addEventListener('click',saveProject);
      ['projectName','projectURL'].forEach(id=>{
        document.getElementById(id).addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); saveProject(); }});
      });
      document.getElementById('toggleSel').addEventListener('click',toggleSelectionMode);
      document.getElementById('deleteSelected').addEventListener('click',deleteSelected);

      // first render
      renderProjects(document.getElementById('listInput'), { selectable:true });

      function saveProject(){
        const name=(document.getElementById('projectName').value||'').trim();
        let url=(document.getElementById('projectURL').value||'').trim();

        if(!name){ alert('Project Name wajib diisi.'); return; }
        
        const projectData = { id:genId(), name, cities: [], url: '' };

        if (url) {
            // MODE URL: URL terisi. Simpan Name dan URL. Abaikan sisanya.
            if(url && !/^https?:\/\//i.test(url)) url='https://'+url;
            if(url){ try{ new URL(url); }catch{ alert('URL project tidak valid.'); return; } }
            
            projectData.url = url;
            
        } else {
            // MODE CITY/DEFAULT: URL kosong. Simpan Cities & Interviewers.

            // 1. COLLECT AND VALIDATE CITIES & INTERVIEWERS
            const collectedCities = [];
            let valid = true;

            document.querySelectorAll('#cities .city-wrapper').forEach(cityWrapper => {
                const cityName = (cityWrapper.querySelector('.city-name').value || '').trim();
                const cityInterviewers = [];
                const ivSections = cityWrapper.querySelectorAll('.iv-section');

                // Skip if the wrapper is essentially empty (default empty row)
                if (!cityName && ivSections.length === 1 && ivSections[0].querySelector('.iv-name').value.trim() === '') {
                    return;
                }

                // VALIDATION: City Name must be filled if interviewers exist
                if (!cityName) {
                    alert('City Name wajib diisi jika ada Interviewer di dalamnya.');
                    valid = false;
                    return;
                }
                
                // Iterate through interviewers nested in this city
                ivSections.forEach(ivSection => {
                    const n = (ivSection.querySelector('.iv-name').value || '').trim();
                    const links = [];

                    // Collect links for this interviewer
                    ivSection.querySelectorAll('.iv-link').forEach(input => {
                        let l = (input.value || '').trim();
                        if (l) {
                            if (!/^https?:\/\//i.test(l)) l = 'https://' + l;
                            try { new URL(l); links.push(l); }
                            catch { alert(`Salah satu Interviewer Link (${l}) tidak valid di kota ${cityName}.`); valid = false; }
                        }
                    });

                    if (!valid) return;
                    
                    // Skip entirely empty interviewer rows
                    if (!n && links.length === 0) return;

                    // VALIDATION: Interviewer Name is mandatory
                    if (!n) { alert(`Interviewer Name wajib diisi di kota ${cityName}.`); valid = false; return; }
                    
                    // VALIDATION: At least one valid link is mandatory
                    if (links.length === 0) { alert(`Interviewer "${n}" wajib memiliki minimal satu Link yang valid di kota ${cityName}.`); valid = false; return; }

                    cityInterviewers.push({ name: n, links: links });
                });

                if (!valid) return;
                
                // FINAL VALIDATION: City must have at least one interviewer 
                if (cityInterviewers.length === 0) {
                    alert(`City "${cityName}" wajib memiliki minimal satu Interviewer.`);
                    valid = false;
                    return;
                }

                // If validation passed, add the city data
                collectedCities.push({ cityName, interviewers: cityInterviewers });
            });

            if(!valid) return;

            // 3. APPLY DATA
            projectData.url = '';
            projectData.cities = collectedCities;

            // FINAL VALIDATION: Must save either URL or cities
            if (collectedCities.length === 0) {
                 alert('Anda harus mengisi Project URL atau setidaknya satu City dengan Interviewer.');
                 return;
            }
        }

        // FINAL SAVE
        upsert(projectData);
        
        // Reset form
        document.getElementById('projectName').value='';
        document.getElementById('projectURL').value='';

        // Reinitialize inputs
        citiesContainer.innerHTML=''; addCityInput(citiesContainer);
        updateInputMode(); // Reset input visibility

        renderProjects(document.getElementById('listInput'), { selectable:true });
      }

      function toggleSelectionMode(){
        selectionMode=!selectionMode;
        selectedIds.clear();
        document.getElementById('toggleSel').textContent = `Selection Mode: ${selectionMode?'ON':'OFF'}`;
        document.getElementById('deleteSelected').classList.toggle('show', selectionMode);
        renderProjects(document.getElementById('listInput'), { selectable:true });
      }

      function deleteSelected(){
        if(!selectedIds.size){ alert('Tidak ada project yang dipilih.'); return; }
        const pin=prompt('Enter PIN to delete selected projects:');
        if(pin!=='13579'){ alert('Incorrect PIN.'); return; }
        removeByIds([...selectedIds]);
        selectedIds.clear();
        renderProjects(document.getElementById('listInput'), { selectable:true });
        alert('Selected projects deleted.');
      }
    }
    
    // ===================================
    // NEW: DETAIL PAGE RENDERER
    // ===================================

    function renderDetail(projectId) {
        const item = findById(projectId);
        const app = document.getElementById('app');

        if (!item) {
            app.innerHTML = `
                <div class="toolbar">
                    <button class="btn" onclick="location.hash='#/list';">← Back to List</button>
                </div>
                <section class="frame section">
                    <h2 class="title" style="font-size:28px;">Project Not Found</h2>
                    <p class="subtitle">ID Project tidak valid atau sudah dihapus.</p>
                </section>
            `;
            return;
        }

        let detailContent = '';

        if (item.url) {
            detailContent += `
                <p class="subtitle" style="margin-top:0;">Main URL:</p>
                <div class="detail-container">
                    <a href="${esc(item.url)}" target="_blank" rel="noopener noreferrer" class="link-btn" style="width: 100%; text-align: center;">Open Project Link</a>
                </div>
            `;
        }

        if (item.cities && item.cities.length > 0) {
            item.cities.forEach(cityData => {
                const cityName = esc(cityData.cityName || 'Unknown City');
                const interviewers = cityData.interviewers || [];

                detailContent += `
                    <p class="subtitle" style="margin-top: 24px; font-size: 18px;">Interviewer di Kota: <b>${cityName}</b></p>
                    <div class="detail-container">
                `;
                
                interviewers.forEach(iv => {
                    const ivName = esc(iv.name || 'Interviewer');
                    const links = iv.links || [];

                    let linkButtons = links.map((link, index) => {
                        const linkText = links.length > 1 ? `Link ${index + 1}` : 'Link Project';
                        return `<a href="${esc(link)}" target="_blank" rel="noopener noreferrer" class="link-btn">${linkText}</a>`;
                    }).join('');

                    detailContent += `
                        <div class="detail-interviewer">
                            <strong>${ivName}</strong>
                            <div class="link-btn-container">
                                ${linkButtons}
                            </div>
                        </div>
                    `;
                });
                detailContent += `</div>`;
            });
        }
        
        if (!item.url && (!item.cities || item.cities.length === 0)) {
            detailContent += `<p class="subtitle">Tidak ada URL utama, Kota, maupun Interviewer yang tercatat.</p>`;
        }


        app.innerHTML = `
            <div class="toolbar">
                <button class="btn" onclick="location.hash='#/list';">← Back to List</button>
            </div>
            <section class="frame section">
                <h2 class="title" style="font-size:32px; margin-bottom: 24px;">${esc(item.name)}</h2>
                ${detailContent}
            </section>
        `;
    }

    /* ============== List Page (read-only) ============== */
    function renderList(){
      migrateIds();
      const app=document.getElementById('app');
      app.innerHTML=`
        <div class="toolbar">
          <button class="btn" onclick="location.hash='#/';">← Back</button>
        </div>
        <section class="frame section">
          <h2 class="title" style="font-size:28px;">List Projects</h2>
          <div class="links" id="listOnly"></div>
        </section>
      `;
      renderProjects(document.getElementById('listOnly'), { selectable:false });
    }

    /* ============== Render Cards (shared) ============== */
    function renderProjects(container, {selectable}){
      const data=readAll();
      container.innerHTML='';

      if(!data.length){
        const p=document.createElement('p'); p.className='label'; p.style.marginTop='8px';
        p.textContent='Belum ada project. Tambahkan lewat "Input Projects".';
        container.parentElement.appendChild(p); return;
      }

      const grid=document.createElement('div'); grid.className='links';

      data.forEach(item=>{
        const title=`<div class="card-title">${esc(item.name)}</div>`;
        
        let metaHtml = '';
        const allTags = [];
        let cityCount = 0;
        let totalInterviewers = 0;

        if (item.url) {
            metaHtml += `<div class="card-meta">URL: ${esc(item.url)}</div>`;
        }

        if (item.cities && item.cities.length > 0) {
            item.cities.forEach(cityData => {
                const cityName = cityData.cityName || 'Unknown City';
                const interviewers = cityData.interviewers || [];
                cityCount++;
                totalInterviewers += interviewers.length;

                // Display City Name (in meta section)
                metaHtml += `<div class="card-meta">CITY: <b>${esc(cityName)}</b> (${interviewers.length} Interviewer)</div>`;

                // Collect interviewer tags for this city
                interviewers.forEach(iv => {
                    const nm = esc(iv.name || 'Interviewer');
                    const links = iv.links || [];

                    const firstLink = links[0];
                    const allLinks = links.length > 1 ? ` (${links.length} links)` : '';
                    
                    const cityAbbr = esc(cityName.substring(0, 5)).toUpperCase();
                    
                    if (firstLink) {
                        allTags.push(
                            `<span class="tag" title="${esc(cityName)} - Links:\n${links.map(l => esc(l)).join('\n')}">
                                <a href="${esc(firstLink)}" target="_blank" rel="noopener" onclick="event.stopPropagation();">${nm} (${cityAbbr})${allLinks}</a>
                            </span>`
                        );
                    } else {
                        allTags.push(
                             `<span class="tag">${nm} (${cityAbbr})${allLinks}</span>`
                        );
                    }
                });
            });
        }
        
        if (!item.url && cityCount === 0) {
            metaHtml += `<div class="card-meta">No URL or City</div>`;
        }
        
        const tagsHtml = allTags.join('');


        // MODIFIED: Use .card-clickable and add onclick handler for detail view
        const elm = document.createElement('div');
        elm.className = 'card-clickable';
        elm.onclick = () => location.hash = `#/detail/${item.id}`; 
        
        elm.innerHTML=`${title}${metaHtml}${tagsHtml}`;

        if(selectable){
          elm.classList.add('pad-left');
          const cb=document.createElement('input');
          cb.type='checkbox'; cb.className='select-box';
          cb.checked = selectedIds.has(item.id);
          cb.addEventListener('change', e=>{
            // Prevent navigating to detail when clicking checkbox
            e.stopPropagation(); 
            if(e.target.checked) selectedIds.add(item.id); else selectedIds.delete(item.id);
          });
          // Ensure clicking the card wrapper doesn't open the link if there's a checkbox
          elm.onclick = (e) => {
              if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'A' && e.target.parentElement.tagName !== 'A') {
                  location.hash = `#/detail/${item.id}`; 
              }
          };

          elm.appendChild(cb);
        }

        grid.appendChild(elm);
      });

      container.replaceWith(grid); grid.id=container.id;
    }

    /* ============== Helpers ============== */
    const esc=(s='')=>String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
</script>
</body>
</html>
