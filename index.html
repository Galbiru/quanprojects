<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project Bestari - Survey Panel</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background: #020617;
            color: white;
            padding: 20px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
        }

        .theme-blue {
            --bg-main: #1e3a8a;
            --bg-soft: #3b82f6;
        }

        .theme-pink {
            --bg-main: #831843;
            --bg-soft: #ec4899;
        }

        .theme-dark {
            --bg-main: #0f172a;
            --bg-soft: #1e293b;
        }

        .card {
            background: var(--bg-main);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 10px;
        }

        .nav-btn {
            background: var(--bg-soft);
        }

        .back-btn {
            padding: 6px 14px;
            background: #475569;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 12px;
            display: inline-block;
        }
    </style>
</head>

<body class="theme-blue">

    <!-- =======================
         PAGE: WELCOME
    ======================== -->
    <div id="page-welcome" class="page active">
        <h1 class="text-3xl font-bold mb-2">Project Bestari</h1>
        <p class="text-sm opacity-70 mb-4">
            Panel Survey Terintegrasi untuk Enumerator
        </p>

        <button id="btn-enter" class="btn bg-blue-600 hover:bg-blue-700">
            ENTER DASHBOARD
        </button>

        <div class="mt-6">
            <button id="btn-itmode-open" class="text-xs underline opacity-60 hover:opacity-100">
                IT MODE
            </button>
        </div>
    </div>



    <!-- =======================
         PAGE: KOTA LIST
    ======================== -->
    <div id="page-kota" class="page">
        <div class="back-btn" data-back="welcome">← Kembali</div>
        <h2 class="text-xl font-bold mb-4">Pilih Kota</h2>
        <div id="list-kota"></div>
    </div>



    <!-- =======================
         PAGE: USER LIST
    ======================== -->
    <div id="page-users" class="page">
        <div class="back-btn" data-back="kota">← Kembali</div>
        <h2 class="text-xl font-bold mb-4" id="title-users"></h2>
        <div id="list-users"></div>
    </div>



    <!-- =======================
         PAGE: MULTIPLE LINKS
    ======================== -->
    <div id="page-multi" class="page">
        <div class="back-btn" data-back="users">← Kembali</div>
        <h2 class="text-xl font-bold mb-4" id="multi-username"></h2>
        <div id="list-multi"></div>
    </div>



    <!-- =======================
         PAGE: IT MODE (PASSWORD)
    ======================== -->
    <div id="page-it-pass" class="page">
        <div class="back-btn" data-back="welcome">← Kembali</div>
        <h2 class="text-xl font-bold mb-4">Masukkan Password IT Mode</h2>

        <input id="input-it-pass" 
               type="password" 
               class="w-full p-2 rounded bg-gray-800 border border-gray-600 mb-3" 
               placeholder="Password">

        <button id="btn-it-pass-submit" class="btn bg-green-600 hover:bg-green-700">
            MASUK
        </button>
    </div>



    <!-- =======================
         PAGE: IT MODE PANEL
    ======================== -->
    <div id="page-it" class="page">
        <div class="back-btn" data-back="welcome">← Kembali</div>
        <h2 class="text-xl font-bold mb-4">IT MODE</h2>

        <!-- Theme -->
        <h3 class="font-semibold mb-1">Tema Warna</h3>
        <select id="select-theme" class="w-full p-2 rounded bg-gray-800 border border-gray-600 mb-4">
            <option value="theme-blue">Biru Soft</option>
            <option value="theme-pink">Pink Soft</option>
            <option value="theme-dark">Black Night</option>
        </select>

        <!-- Use Kota -->
        <div class="flex items-center gap-3 mb-4">
            <input id="check-use-kota" type="checkbox" />
            <label>Gunakan Kota</label>
        </div>

        <!-- Kota List -->
        <h3 class="font-semibold mb-1">Daftar Kota</h3>
        <div id="edit-kota"></div>

        <button id="btn-add-kota" class="btn bg-blue-600 hover:bg-blue-700 mt-2 mb-6">
            + Tambah Kota
        </button>

        <!-- Save -->
        <button id="btn-it-save" class="btn bg-green-600 hover:bg-green-700 w-full">
            SIMPAN PENGATURAN
        </button>
    </div>
    <!-- =======================
         SCRIPTS
    ======================== -->
    <script>
        /* ========================================
           GLOBAL STATE
        ======================================== */
        let CONFIG = {
            theme: "theme-blue",
            useKota: false,
            kota: []
        };

        let CURRENT_KOTA_INDEX = null;
        let CURRENT_USER_INDEX = null;

        /* ========================================
           PAGE HANDLER
        ======================================== */
        function showPage(id) {
            document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
            document.getElementById(`page-${id}`).classList.add("active");
        }

        document.querySelectorAll(".back-btn").forEach(btn => {
            btn.addEventListener("click", () => showPage(btn.dataset.back));
        });


        /* ========================================
           LOAD CONFIG FROM API
        ======================================== */
        async function loadConfig() {
            try {
                const res = await fetch("/api/config");
                CONFIG = await res.json();
                applyTheme();
            } catch (e) {
                console.error("Gagal load config:", e);
            }
        }

        /* ========================================
           SAVE CONFIG TO API
        ======================================== */
        async function saveConfig() {
            await fetch("/api/config", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(CONFIG)
            });
        }

        /* ========================================
           APPLY THEME
        ======================================== */
        function applyTheme() {
            document.body.className = CONFIG.theme || "theme-blue";
        }


        /* ========================================
           WELCOME → DASHBOARD
        ======================================== */
        document.getElementById("btn-enter").addEventListener("click", () => {
            if (CONFIG.useKota) {
                renderKotaList();
                showPage("kota");
            } else {
                // tanpa kota → langsung tampilkan semua user
                CURRENT_KOTA_INDEX = null;
                renderUserListAll();
                showPage("users");
            }
        });


        /* ========================================
           IT MODE — PASSWORD
        ======================================== */
        document.getElementById("btn-itmode-open").addEventListener("click", () => {
            showPage("it-pass");
        });

        document.getElementById("btn-it-pass-submit").addEventListener("click", () => {
            const pass = document.getElementById("input-it-pass").value.trim();
            if (pass === "Aco123") {
                renderITMode();
                showPage("it");
            } else {
                alert("Password salah.");
            }
        });


        /* ========================================
           RENDER IT MODE PANEL
        ======================================== */
        function renderITMode() {
            document.getElementById("select-theme").value = CONFIG.theme;
            document.getElementById("check-use-kota").checked = CONFIG.useKota;

            renderEditKota();
        }


        /* ========================================
           EDIT KOTA LIST
        ======================================== */
        function renderEditKota() {
            const wrap = document.getElementById("edit-kota");
            wrap.innerHTML = "";

            CONFIG.kota.forEach((k, i) => {
                const div = document.createElement("div");
                div.className = "p-3 bg-gray-800 rounded mb-2";

                div.innerHTML = `
                    <input value="${k.nama}"
                           data-idx="${i}"
                           class="w-full p-2 rounded bg-gray-700 border border-gray-600 kota-name mb-2"
                           placeholder="Nama Kota">

                    <button class="btn bg-blue-700 w-full mb-2" data-user="${i}">
                        Kelola User Kota Ini
                    </button>

                    <button class="btn bg-red-600 w-full delete-kota" data-del="${i}">
                        Hapus Kota
                    </button>
                `;

                wrap.appendChild(div);
            });

            // tombol kelola user
            document.querySelectorAll("[data-user]").forEach(btn => {
                btn.addEventListener("click", e => {
                    const idx = e.target.dataset.user;
                    CURRENT_KOTA_INDEX = idx;
                    renderUserList(idx);
                    showPage("users");
                });
            });

            // tombol hapus kota
            document.querySelectorAll(".delete-kota").forEach(btn => {
                btn.addEventListener("click", e => {
                    const del = e.target.dataset.del;
                    CONFIG.kota.splice(del, 1);
                    renderEditKota();
                });
            });
        }


        /* ========================================
           TAMBAH KOTA
        ======================================== */
        document.getElementById("btn-add-kota").addEventListener("click", () => {
            CONFIG.kota.push({
                nama: "Kota Baru",
                users: []
            });
            renderEditKota();
        });


        /* ========================================
           IT MODE — SAVE
        ======================================== */
        document.getElementById("btn-it-save").addEventListener("click", async () => {
            // save nama kota
            document.querySelectorAll(".kota-name").forEach(input => {
                const idx = input.dataset.idx;
                CONFIG.kota[idx].nama = input.value.trim();
            });

            // save pilihan
            CONFIG.theme = document.getElementById("select-theme").value;
            CONFIG.useKota = document.getElementById("check-use-kota").checked;

            await saveConfig();
            applyTheme();

            alert("Pengaturan disimpan!");
        });
        /* ========================================
           RENDER LIST KOTA (USER SIDE)
        ======================================== */
        function renderKotaList() {
            const wrap = document.getElementById("list-kota");
            wrap.innerHTML = "";

            CONFIG.kota.forEach((k, i) => {
                const div = document.createElement("div");
                div.className = "card cursor-pointer";
                div.innerHTML = `
                    <div class="text-lg font-semibold">${k.nama}</div>
                    <div class="text-sm opacity-70">${k.users.length} User</div>
                `;

                div.addEventListener("click", () => {
                    CURRENT_KOTA_INDEX = i;
                    renderUserList(i);
                    showPage("users");
                });

                wrap.appendChild(div);
            });
        }


        /* ========================================
           RENDER USER LIST FOR SPECIFIC KOTA
        ======================================== */
        function renderUserList(kotaIndex) {
            const wrap = document.getElementById("list-users");
            wrap.innerHTML = "";

            const kota = CONFIG.kota[kotaIndex];
            document.getElementById("title-users").innerText = `User – ${kota.nama}`;

            kota.users.forEach((u, i) => {
                const div = document.createElement("div");
                div.className = "card cursor-pointer";
                div.innerHTML = `
                    <div class="font-semibold">${u.name}</div>
                    <div class="text-sm opacity-70">${u.mode === "single" ? "Single Link" : "Multiple Link"}</div>
                `;

                div.addEventListener("click", () => {
                    CURRENT_USER_INDEX = i;

                    if (u.mode === "single") {
                        window.open(u.links[0], "_blank");
                    } else {
                        renderMultiLinks(kotaIndex, i);
                        showPage("multi");
                    }
                });

                wrap.appendChild(div);
            });

            // Tambah user
            const btn = document.createElement("button");
            btn.className = "btn bg-blue-600 hover:bg-blue-700 w-full mt-4";
            btn.innerText = "+ Tambah User";

            btn.addEventListener("click", () => {
                CONFIG.kota[kotaIndex].users.push({
                    name: "User Baru",
                    mode: "single",
                    links: [""]
                });
                renderUserList(kotaIndex);
            });

            wrap.appendChild(btn);
        }


        /* ========================================
           RENDER USER LIST (NO KOTA MODE)
        ======================================== */
        function renderUserListAll() {
            const wrap = document.getElementById("list-users");
            wrap.innerHTML = "";

            document.getElementById("title-users").innerText = "Daftar User";

            CONFIG.users.forEach((u, i) => {
                const div = document.createElement("div");
                div.className = "card cursor-pointer";
                div.innerHTML = `
                    <div class="font-semibold">${u.name}</div>
                    <div class="text-sm opacity-70">${u.mode === "single" ? "Single Link" : "Multiple Link"}</div>
                `;

                div.addEventListener("click", () => {
                    CURRENT_USER_INDEX = i;

                    if (u.mode === "single") {
                        window.open(u.links[0], "_blank");
                    } else {
                        renderMultiLinksAll(i);
                        showPage("multi");
                    }
                });

                wrap.appendChild(div);
            });
        }


        /* ========================================
           MULTIPLE LINK — RENDER
        ======================================== */
        function renderMultiLinks(kotaIndex, userIndex) {
            const wrap = document.getElementById("list-multi");
            wrap.innerHTML = "";

            const user = CONFIG.kota[kotaIndex].users[userIndex];
            document.getElementById("multi-username").innerText = user.name;

            user.links.forEach((url, i) => {
                const btn = document.createElement("button");
                btn.className = "btn nav-btn w-full mb-2";
                btn.innerText = `Link ${i + 1}`;

                btn.addEventListener("click", () => {
                    window.open(url, "_blank");
                });

                wrap.appendChild(btn);
            });
        }


        /* ========================================
           MULTIPLE LINK — NO KOTA
        ======================================== */
        function renderMultiLinksAll(userIndex) {
            const wrap = document.getElementById("list-multi");
            wrap.innerHTML = "";

            const user = CONFIG.users[userIndex];
            document.getElementById("multi-username").innerText = user.name;

            user.links.forEach((url, i) => {
                const btn = document.createElement("button");
                btn.className = "btn nav-btn w-full mb-2";
                btn.innerText = `Link ${i + 1}`;

                btn.addEventListener("click", () => {
                    window.open(url, "_blank");
                });

                wrap.appendChild(btn);
            });
        }


        /* ========================================
           STARTUP
        ======================================== */
        loadConfig();
    </script>
</body>
</html>
